name: "00 - Bootstrap Foundation"
on:
  workflow_dispatch:

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"

      - name: "Authenticate (Skeleton Key)"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Setup Terraform"
        uses: "hashicorp/setup-terraform@v3"
        with:
          terraform_version: "1.7.0"

      - name: "Execute Bootstrap Script"
        run: |
          chmod +x scripts/bootstrap.sh
          # Pass the ID as an argument to force the script to see it
          ./scripts/bootstrap.sh "${{ vars.GCP_PROJECT_ID }}"
        env:
          PROJECT_ID: "${{ vars.GCP_PROJECT_ID }}"

      - name: "Initial Terraform Apply (WIF Bridge)"
        run: |
          cd infrastructure/environments/prod
          # Initialize Terraform
          terraform init -backend-config="bucket=${{ vars.GCP_PROJECT_ID }}-tf-state"

          # Apply using the .tfvars file
          terraform apply -auto-approve -var-file="prod.tfvars"
