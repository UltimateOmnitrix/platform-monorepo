name: "Identity Verification"

# Trigger on every push to main or manually to verify the link
on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    verify:
        runs-on: ubuntu-latest
        # CRITICAL: These permissions allow GitHub to issue an OIDC token
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: "Checkout Repository"
              uses: "actions/checkout@v4"

            - name: "Authenticate to Google Cloud (Keyless)"
              id: "auth"
              uses: "google-github-actions/auth@v2"
              with:
                  # Use the full provider path from your GitHub variables
                  workload_identity_provider: "${{ vars.WIF_PROVIDER_ID }}"
                  # Use the automation service account email
                  service_account: "platform-automation-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

            - name: "Set up Cloud SDK"
              uses: "google-github-actions/setup-gcloud@v2"
              with:
                  project_id: "${{ vars.GCP_PROJECT_ID }}"

            - name: "Proof of Access"
              # If this step turns Green, your WIF Bridge is officially working
              run: |
                  echo "ðŸš€ Testing keyless access to GCP..."
                  gcloud storage buckets list --project="${{ vars.GCP_PROJECT_ID }}"
                  echo "âœ… Identity Verification Successful!"
