name: "00 - Bootstrap Foundation"
on:
  workflow_dispatch: # Run manually from the Actions tab

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"
        with:
          project_id: "${{ vars.GCP_PROJECT_ID }}"

      - name: "Setup Terraform"
        uses: "hashicorp/setup-terraform@v3"
        with:
          terraform_version: "1.14.3"

      - name: "Execute Bootstrap Script"
        # This script enables APIs and ensures the GCS bucket is ready
        run: |
          chmod +x scripts/bootstrap.sh
          ./scripts/bootstrap.sh
        env:
          PROJECT_ID: "${{ vars.GCP_PROJECT_ID }}"
          BUCKET_NAME: "${{ vars.GCP_PROJECT_ID }}-tf-state"

      - name: "Initial Terraform Apply (WIF Bridge)"
        run: |
          cd infrastructure/environments/prod
          terraform init -backend-config="bucket=${{ vars.GCP_PROJECT_ID }}-tf-state"
          terraform apply -auto-approve \
            -var="project_id=${{ vars.GCP_PROJECT_ID }}" \
            -var="github_repo=UltimateOmnitrix/platform-monorepo"
