name: "02 - Manual Infra Plan"

on:
    workflow_dispatch: # Only manual trigger

permissions:
    contents: read
    id-token: write
    pull-requests: write # Required for PR comments

env:
    PROJECT_ID: "platformproject-481722"

jobs:
    plan:
        name: "Terraform Plan"
        runs-on: ubuntu-latest
        strategy:
            matrix:
                layer: [vpc, gke] # Loops through both layers

        steps:
            - name: "Checkout"
              uses: actions/checkout@v4

            - name: "Authenticate to Google Cloud"
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: "${{ vars.WIF_PROVIDER_ID }}"
                  service_account: "platform-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com"

            - name: "Setup Terraform"
              uses: hashicorp/setup-terraform@v3

            - name: "Terraform Init"
              working-directory: infrastructure/environments/prod/${{ matrix.layer }}
              run: |
                  terraform init \
                    -backend-config="bucket=${{ env.PROJECT_ID }}-tf-state"

            - name: "Terraform Plan"
              id: tf-plan
              working-directory: infrastructure/environments/prod/${{ matrix.layer }}
              run: terraform plan -no-color -var-file="../prod.tfvars"

            # This posts the plan to your PR if one is open for the current branch
            - name: "Post Plan Comment"
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
              env:
                  PLAN: "${{ steps.tf-plan.outputs.stdout }}"
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const output = `#### üìñ Layer: ${{ matrix.layer }} 
                      #### ‚öôÔ∏è Terraform Plan: \`Success\`

                      <details><summary>Click to expand Plan Details</summary>

                      \`\`\`hcl
                      ${process.env.PLAN}
                      \`\`\`

                      </details>

                      *Triggered manually by: @${{ github.actor }}*`;

                      // Note: This requires an active PR to function correctly
                      if (context.issue.number) {
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: output
                        })
                      }
